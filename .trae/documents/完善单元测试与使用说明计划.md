## 目标
- 增加完整的单元测试（协议编解码、服务端各组件、内存统计与队列、端到端客户端流程）。
- 完整、可操作的项目使用说明（构建、运行、协议、测试、扩展点）。

## 测试覆盖计划
### protocol
- 为 `protocol/message.go` 添加编解码测试：Request/Response/各 Params 的编码解码一致性；非法 JSON 解析失败。
- 验证 `id:null` 与 `id:number` 两类消息的处理。

### server 组件
- Acceptor（`app/server/acceptor.go:22-55`）：
  - 正常授权成功并返回 Response true；用户名为空返回 unauthorized；非二进制帧返回 invalid opcode。
- Listener（`app/server/listener.go:24-45, 47-82, 84-89`）：
  - 正确提交返回 true；错误结果返回 "Invalid result"；1 秒内超频返回 "Submission too frequent"；重复 nonce 返回 "Duplicate submission"；job 不存在返回 "Task does not exist"；历史 job 校验通过（读 `history`）。
- Coordinator（`app/server/coordinator.go:36-77`）：
  - 定时轮换 nonce 并递增 job_id；更新每会话 latest_job_id/server_nonce；历史记录写入；验证 `Push` 调用次数与参数（使用 fake ServerPusher）。
- State（`app/server/listener.go:97-100`）：
  - 断开连接后会话被移除。

### stats（`stats/memory.go:1-39`）
- `Increment/Get` 按分钟截断；并发增量正确；不存在的键返回 0。

### mq（`mq/memory.go:1-32`）
- Publish/Subscribe 正常；Close 后发布不 panic；订阅通道关闭语义正确。

### 端到端客户端
- 使用真实 TCP：启动 `AppServer`（短 interval，例如 200ms），客户端授权、接收 job、计算 `SHA256(server_nonce+client_nonce)` 并提交，验证成功响应。
- 验证客户端 1 次/秒的上限与至少 1 次/分钟的保底提交（通过缩短时间窗口与断言）。
- 校验示例：`SHA256("123"+"456")` 十六进制值为 `8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92`。

## 使用说明完善
- Quick Start：
  - 构建：`go build ./cmd/kupool-server` 与 `go build ./cmd/kupool-client`
  - 运行服务端：`./kupool-server -addr :8080 -interval 30s`
  - 运行客户端：`./kupool-client -addr 127.0.0.1:8080 -username admin`
- 协议细节与示例：授权、任务、提交、错误响应的 JSON；`id:null` 用于无响应消息。
- 测试说明：`go test ./... -v`；并发与错误场景说明；如何观察日志。
- 架构说明与可插拔扩展：StatsStore（默认 memory，可替换 PostgreSQL），MessageQueue（默认 memory，可替换 RabbitMQ）。
- 目录结构与关键文件索引：
  - 服务器入口：`cmd/kupool-server/main.go`
  - 客户端入口：`cmd/kupool-client/main.go`
  - 协议：`protocol/message.go`
  - 服务器组件：`app/server/*`（acceptor/listener/coordinator）
  - 存储与队列：`stats/*`、`mq/*`

## 交付与验证
- 所有测试位于对应包下（`protocol`, `app/server`, `stats`, `mq`, `client/app`），合理使用 `t.Parallel()`。
- 在 macOS/Linux 上执行：`go build ./...` 与 `go test ./... -v` 全部通过。
- README 更新包含构建运行、协议、测试与扩展说明。

## 执行顺序
1. 编写 protocol 测试。
2. 编写 server 组件单元测试（acceptor/listener/coordinator/state）。
3. 编写 stats 与 mq 测试。
4. 编写端到端客户端测试（短周期）。
5. 扩充 README 使用说明并核对所有示例。

请确认以上计划，确认后我将开始补充测试并完善 README。